# -*- coding: utf-8 -*-
"""
Created on Fri Feb  2 17:32:53 2024

@author: Yuhas
"""

import rng

SHINY_SEEDS = [321089196, 58940779, 1494208023, 1756305755, 2319945170, 3171903398, 2477203661, 2686919312, 1992237211, 1959499018, 2182324550, 2123337503, 3669956239, 216215750, 1055095249, 3873135986, 2536200430, 3637245241, 2470656464, 2673853684, 3230886073, 714315022, 3597924119, 471801675, 4148417803, 3860034048, 3728969028, 1533510826, 360427271, 3263661301, 1310656943, 1880838442, 3008057028, 3178466689, 2064349907, 4181160279, 2392021438, 1369654290, 1494200301, 1441745201, 4253274265, 1520400530, 1474559214, 3506167475, 2031562511, 3237444503, 498013389, 1291008223, 2837656051, 2549308146, 353875657, 2038124572, 2182348261, 825748543, 3230923137, 3997665738, 2575504418, 2044660061, 1441771521, 4004188289, 1474501637, 642229905, 3787977282, 1146840984, 3774811277, 1782542218, 2726294748, 753662078, 3047393784, 4213911602, 2234733469, 3060489111, 1310692110, 3506154432, 3512678302, 3112906464, 1920139792, 288308808, 3755170056, 2011908381, 1572837311, 334225944, 1507301422, 222790555, 1140315824, 2267491802, 3781372345, 4174606219, 589787772, 2477258301, 1789102708, 26209342, 3932121386, 3342325832, 2110227457, 629097304, 1789089933, 3761738179, 2208505659, 3984546816, 1277927374, 373515646, 262097152, 1579357090, 6547684, 1002635567, 3355436157, 1867741586, 2536195848, 3728952383, 3053950020, 1251685722, 2352727154, 4135292181, 2175787028, 137561604, 3997669501, 3545481792, 897791213, 1461447523, 3086731725, 2719723793, 2129870055, 4135321436, 668465627, 2411696891, 2005360635, 196559692, 2516548329, 3846935043, 1526972119, 2024998046, 1022314015, 3322628353, 1979133818, 1730123055, 2772149667, 2811481370, 2837706571, 2156096441, 910917277, 1815285359, 2287171761, 3427512425, 2752475531, 1920167949, 2719696790, 1422120710, 268670906, 694661187, 1448329757, 2903217814, 2005353328, 2431347269, 3322666292, 4286048453, 1848109375, 3152233719, 2260952606, 3552029951, 2588649850, 1841544379, 1022312888, 3748627644, 4109052944, 3047391262, 1264796565, 3086711509, 1127175945, 3132600294, 4082833345, 694640942, 1323814927, 412852757, 891231877, 131033420, 1140262336, 3814174737, 406262329, 517672746, 1972622366, 1625281975, 3335769607, 491516607, 3060467382, 3925573401, 3158830222, 950239805, 2726291099, 4161511615, 1736662144, 3827283165, 2509989437, 3860066026, 1671135073, 1644946463, 2700078258, 2162640391, 2510015313, 2457537879, 766765835, 2863915424, 458717918, 1795633200, 1107530352, 2182334667, 498033007, 1638354716, 3571678017, 629124481, 19642431, 3145708751, 504569074, 340732649, 4056671662, 3637239041, 622547288, 2588652131, 1009213365, 117909918, 104844705, 334229957, 222821600, 39270328, 3302953311, 1618706456, 3145715835, 3997654530, 3919035792, 2437888744, 1395865792, 3866620202, 1042002272, 163807387, 3565115110, 517681785, 1461396405, 3342300456, 1546649364, 1638380043, 1946400928, 4181131330, 1992249743, 2201965394, 1356535734, 2863874193, 229348300, 1317211530, 1658035550, 1251682399, 1264826811, 98294158, 2254431535, 3381624408, 1907096583, 2614880769, 2818006289, 1015796796, 3329175028, 806050734, 1677706336, 2962163139, 655335809, 2392052021, 131055870, 2686939372, 806069852, 1120600350, 2752482760, 4200842249, 1389315245, 1546592691, 4076319313, 111383053, 4168084523, 2267498096, 3964869089, 2280593142, 248989001, 2142977220, 2732790410, 2582076063, 3997658130, 3827272863, 3460258454, 3034262156, 190032809, 3283316268, 3499606474, 288313071, 1618706543, 1317239939, 2896629339, 576692128, 1513849088, 1900513846, 3853497930, 2011901929, 3394761379, 1625235274, 3971454551, 1094434266, 2693523678, 3512685529, 137596249, 2719721847, 2568997363, 78594367,
               2437884296, 1592485788, 2247859261, 3198148436, 615983890, 1651502949, 3840400853, 733958147, 3080189621, 4017317489, 4279457829, 2287163057, 1769450915, 3637212614, 2863911034, 98283530, 1723536580, 734002978, 1094409323, 353853435, 2208509951, 2916302674, 2260982687, 1107517307, 3420945646, 2673814462, 268637511, 72083908, 701173996, 773269605, 2260942583, 1369645894, 2503418761, 373524221, 629113659, 3899355621, 3001520227, 2306839445, 2555903694, 360431976, 2536180029, 3086736595, 3394728388, 1094426247, 3715827424, 3099845898, 3519270442, 1553142687, 3683095411, 4004190327, 2660719445, 2319950230, 2182339006, 32766788, 4272897145, 1612170445, 1802196221, 1533529373, 2392048640, 825709618, 760164911, 3224336229, 1081338566, 1310711621, 589766409, 3774859746, 766722274, 229358167, 3106382572, 832269782, 2411691653, 2608307560, 3388194573, 2083987073, 720873044, 4272884977, 2005343363, 3152255203, 412817050, 3099789966, 2621423043, 439032114, 1363096829, 3807576672, 2477227868, 1481109574, 2955632701, 3158796412, 812640758, 262142376, 1330373915, 812596831, 2759057786, 982999734, 366978979, 1330338806, 1422093879, 747054925, 3099812907, 3021146122, 589774841, 32730996, 1815300721, 1408990178, 3715840583, 366983262, 740515805, 2287175830, 714318658, 321075388, 163825715, 2909736312, 2647591274, 4286015768, 4102534136, 3257126810, 2247864104, 1009230403, 491518261, 3768302307, 3925564177, 3211200278, 891273204, 1055102871, 1022328828, 3152278173, 969882546, 1474541672, 432534015, 655316939, 1749806150, 3538936914, 2641069049, 2726267781, 1585954890, 3368540191, 2588647161, 1861176760, 111350667, 1336879926, 373549191, 3152275120, 399722388, 3329208354, 439059233, 1232047309, 176943287, 353864621, 170385049, 2339626868, 930599082, 2883562892, 681547771, 150674322, 1192700934, 1402430101, 2752470840, 1736698521, 2890096321, 2680408443, 3493024831, 1546595028, 3466844298, 1979148689, 2962181496, 176915543, 1363140131, 4050067060, 190010589, 3217761538, 1166501312, 373522054, 504620286, 203113134, 2306823762, 2588641780, 910914675, 517710634, 806028128, 3506136638, 1015805342, 3820686091, 216212300, 3748647347, 3971466121, 904344981, 1035409423, 2595169192, 3801061321, 4069724790, 3493022222, 3977979276, 1081292769, 1022309101, 681555462, 2346145654, 4010798728, 4069746827, 2542782116, 2627934861, 3178438682, 1592467969, 4056647824, 4194245532, 4109043421, 943717261, 4154966737, 2143009122, 2201984713, 2247823391, 3237451027, 170392769, 498016253, 2260964424, 3912465009, 4266363060, 3742079742, 3774840269, 3296437496, 1127168645, 1251731551, 4069747894, 2300269836, 589807917, 1605595812, 2228218895, 1762883395, 2418269065, 2962196271, 189993174, 203107175, 2942518296, 3001531219, 3728991483, 3060486536, 681514231, 3394754956, 530801944, 2444454325, 209702330, 956819998, 3552039901, 1035463130, 209697632, 399762637, 406262113, 3342299278, 1094402871, 2883557288, 3984533778, 72085089, 3316088334, 1408996992, 4115640828, 458742348, 3637192068, 4135290436, 1048525408, 3728944043, 2359270294, 3827270292, 570147029, 3466796367, 3643790720, 2804922099, 3401296328, 609426728, 4115655529, 3001535368, 2201981555, 3309542737, 72058664, 4187691057, 2483776661, 3801055554, 4056670705, 209678128, 4259838255, 4089423896, 989569261, 3008046907, 2228208682, 694655900, 3866563536, 1979132977, 3394725181, 3047420640, 3316060456, 1382788581, 4102518645, 1173064853, 3053953328, 576715018, 4227017350, 1350027476, 4194258883, 1474530879, 353848360, 976428835, 2228164340, 3453688160, 1697322043, 340780509, 3853457360, 26168174, 491486779, 1939836131, 1186137150, 1022345393, 1159975572, 3152244053, 1284477656]
SHINY_INDEX = [2964504, 7784076, 9558998, 23543239, 27087307, 46048465, 48382185, 64985321, 69025246, 77912271, 79278657, 92795446, 96446489, 104482954, 105954818, 114686983, 115094174, 131598641, 151695893, 153152663, 165598948, 169197609, 186907653, 203407134, 209032534, 210489062, 218977420, 224747744, 228653621, 229766715, 255042040, 259742371, 264566137, 280137341, 280386448, 280790719, 281450659, 298531031, 301269789, 313630317, 319282349, 325536103, 329889665, 332209846, 340904243, 353375280, 354243197, 359649617, 364264971, 366611018, 367347613, 368036898, 368362953, 377813954, 384355561, 393859126, 398314897, 399781989, 400412346, 410604904, 414270996, 421513312, 423485648, 441941890, 445481439, 445726487, 450163177, 457373456, 460664080, 479101474, 486702027, 498502669, 501119727, 501611861, 503438994, 505186803, 505505328, 515479595, 516441506, 523903553, 524922100, 525002930, 525870081, 532347665, 544712351, 548223145, 553289242, 559831219, 583232579, 583381277, 596529991, 620323331, 622734797, 627434723, 630478171, 637950828, 647489309, 648089440, 657008380, 661377215, 663417206, 663878378, 672609218, 682391734, 683820387, 691681016, 696807268, 711019114, 718872251, 721837647, 737348395, 737441273, 741912853, 748552399, 750543945, 777053976, 778803867, 781016405, 785990838, 786855647, 787594450, 795998871, 798432127, 806471003, 808722117, 812344690, 826728723, 827490586, 832580140, 832865246, 842736878, 845599890, 847607722, 857913354, 858675948, 870138120, 903783596, 934965790, 936616905, 955300863, 957267661, 959685163, 973949389, 981873593, 991401694, 1006569140, 1009995214, 1016454036, 1017333570, 1020917035, 1021900925, 1024232052, 1029816523, 1037131170, 1042517576, 1048205915, 1052001038, 1055499171, 1078623215, 1081769734, 1088008968, 1092942545, 1100732315, 1110033016, 1111974313, 1131303135, 1133334950, 1139428736, 1143735592, 1156392747, 1157221276, 1174174765, 1174314859, 1181992461, 1188141312, 1219167015, 1222945657, 1253807958, 1257676214, 1264979654, 1272831323, 1277269302, 1280004931, 1285329032, 1285573667, 1286796208, 1287776366, 1302552812, 1306825391, 1321688288, 1343782789, 1352454063, 1358049375, 1367868473, 1369111082, 1377781275, 1380612939, 1390111479, 1441696409, 1446009736, 1446296012, 1449853838, 1451020079, 1459769842, 1467723766, 1469650015, 1471281991, 1473173562, 1490936937, 1504727392, 1508466882, 1518101030, 1518558610, 1524619653, 1524687917, 1530282919, 1542017696, 1546185820, 1554628856, 1586257288, 1586820236, 1588143485, 1596020465, 1611758531, 1614052241, 1615580272, 1621486607, 1628774488, 1635512812, 1635602401, 1644591852, 1645225897, 1651804744, 1652190047, 1652467139, 1671922026, 1678557945, 1692387345, 1697088490, 1705087153, 1717631750, 1724940591, 1727477348, 1731268390, 1735609143, 1739804928, 1748096960, 1757405802, 1768927569, 1773088015, 1778303912, 1787358332, 1789684335, 1796214413, 1796421098, 1810623559, 1817045988, 1820293144, 1823244447, 1828669301, 1838304818, 1842624814, 1842632493, 1846236195, 1850272051, 1852475980, 1857136740, 1861571348, 1880713606, 1894206368, 1900965139, 1912851679, 1913519875, 1919094516, 1919185570, 1922452763, 1924281277, 1931922197, 1934280527, 1936799323, 1938618280, 1940704175, 1947032458, 1957291036, 1958377515, 1962608981, 1984005131, 1984145885, 1989790133, 1996968499, 2028265148, 2033529122, 2046515256, 2046631574, 2050845588, 2054734955, 2069817148, 2072398862, 2087972611, 2098343518, 2102920072, 2109217108, 2122375774, 2133774026, 2135085579, 2138871522, 2146921085, 2169178241, 2171419318, 2177355945, 2196303901, 2201244079, 2201431453, 2205441518, 2218049633, 2235389177,
               2238285489, 2239478184, 2244769765, 2253529549, 2254362015, 2263882556, 2264724602, 2276199368, 2277545127, 2278658726, 2285701592, 2288678562, 2290917403, 2296552552, 2302270897, 2333234651, 2335235768, 2339663722, 2356687237, 2357281586, 2359778035, 2368022598, 2374218014, 2382456342, 2391589547, 2399867544, 2405722651, 2413639849, 2428166673, 2428560688, 2429387384, 2434446560, 2434962832, 2440776452, 2451050615, 2451602452, 2456916664, 2462323497, 2467200393, 2473887770, 2491487213, 2494011983, 2497144776, 2502411434, 2512247297, 2514151373, 2515189148, 2519228037, 2522694663, 2529035060, 2531769805, 2533594353, 2535186048, 2544850908, 2551325478, 2552542784, 2560536302, 2575058121, 2583787779, 2586425644, 2591776241, 2602134303, 2618834817, 2619330894, 2631646990, 2640248597, 2641367857, 2644116397, 2647874879, 2648162493, 2654737894, 2655585603, 2658704381, 2660276491, 2665698996, 2665775481, 2672317303, 2672835443, 2683942948, 2687369158, 2689941855, 2695041857, 2720880693, 2725418706, 2739431840, 2754865806, 2757601259, 2770316828, 2776383093, 2776685864, 2781387580, 2792278964, 2792449651, 2798470075, 2804419884, 2805393940, 2813623746, 2816086427, 2820238926, 2831258874, 2851391922, 2856408713, 2867858618, 2875276821, 2884201894, 2890001878, 2891198502, 2896303446, 2901740400, 2902570815, 2911971168, 2915316813, 2929626665, 2935151970, 2936577867, 2937899458, 2954977778, 2962136784, 2970655380, 2977374969, 2988596580, 2999796623, 3009148359, 3018946707, 3019607345, 3030177075, 3037544189, 3040241717, 3043096766, 3047077211, 3049200634, 3051065495, 3058553969, 3058902019, 3059636957, 3065098905, 3075460890, 3076868343, 3088941152, 3095173782, 3096323049, 3118075677, 3145818557, 3165213547, 3172186365, 3173111531, 3173733287, 3177337280, 3192189528, 3195493286, 3198975778, 3214625237, 3230948048, 3231409302, 3238048192, 3244017322, 3244454248, 3244669191, 3248040544, 3249574035, 3253844060, 3271306154, 3274437824, 3293431263, 3299379936, 3302540334, 3313568536, 3324747758, 3336475382, 3341476279, 3344104378, 3350157955, 3350346485, 3356739266, 3361766675, 3369991861, 3376152432, 3400756722, 3401870794, 3405518730, 3410365603, 3411010612, 3412681342, 3428636306, 3431058113, 3442434192, 3451561918, 3457474102, 3459598075, 3462566801, 3463257543, 3466577403, 3472427053, 3472737591, 3480464635, 3481270056, 3486959045, 3487053898, 3491641373, 3496865465, 3506064441, 3510676997, 3522739287, 3544839133, 3561029348, 3567420413, 3572175944, 3582753038, 3586516322, 3588222460, 3589293615, 3600805497, 3613726970, 3619456196, 3625649192, 3631619072, 3640088094, 3641787042, 3643080980, 3643974936, 3660807946, 3669039287, 3670639828, 3695821684, 3705859639, 3708754754, 3719726038, 3726391743, 3754280055, 3789609198, 3800938792, 3813138402, 3813644008, 3818604002, 3843283140, 3852462675, 3874547145, 3878127073, 3879048181, 3918047193, 3923753707, 3926769359, 3928408221, 3930204344, 3937154980, 3938329099, 3949133574, 3950260086, 3957311497, 3958869918, 3959882752, 3966763952, 3976337760, 3985863652, 3990258816, 4004180427, 4020784936, 4026005205, 4029510751, 4036906753, 4040154993, 4054801346, 4055810266, 4058633103, 4076504364, 4080220255, 4080767204, 4081561806, 4093266710, 4094331982, 4103207918, 4113369987, 4115431898, 4116097805, 4125402876, 4125757952, 4125836555, 4126954899, 4133011591, 4133614119, 4136101225, 4138635275, 4149115334, 4161832225, 4164525214, 4189151579, 4191059855, 4195830086, 4197131837, 4199030495, 4202002321, 4204487448, 4224124701, 4226411761, 4246406804, 4247518552, 4250825661, 4252581081, 4265739631, 4266770364, 4269327363, 4269523707, 4270289135, 4293461397]
# experimentally measured, but with low accuracy
# PID = 0x2671DF8A @ 7:20:36 is index 387273515
# PID = 0xFB095894 @ 7:42:38 is index 387416371
# (387416371 - 387273515) / (22 * 60 + 2) = 108.06.
# PID = 0xE8AE5D9D @ 8:57:07 is index 387894661
# (387894661 - 387273515) / 5791 = 107.26
# Adjusted from 108 to 107.5 when there was a measured slip of 5m over 13h.
AVERAGE_ADVANCES_PER_SECOND = 107.5


def FindShinySeeds():
    seeds = []
    for i in range(1 << 16):
        top = i
        # Needs to be an encounter
        if top % 2880 >= 320:
            continue
        for j in range(1 << 16):
            seed = (top << 16) + j
            seed = rng.advanceRng(seed, 1)
            # Needs to be a Seedot
            if rng.top(seed) % 100 != 99:
                continue
            # print("seedot encounter", i, j)
            poke = rng.WildPokemon(seed)
            shiny = (poke.pid >> 16) ^ (poke.pid & 0xFFFF) ^ 27171 ^ 33452
            if shiny < 8:
                print("shiny", seed)
                seeds.append(seed)
    print(seeds)
    print(len(seeds))


def FindShinyIndecies():
    indecies = []
    for seed in SHINY_SEEDS:
        indecies.append(rng.index(seed))
    indecies.sort()
    print(indecies)
    
    
def FindFirstEncounterForPID(PID, seed):
    # The sed passed in is the seed of the upper bit, but it's easier to code
    # the loop if we reverse once so it's the seed of the lower
    seed = rng.reverseRng(seed, 1)
    # The game first creates a tentative PID, then generates PIDs until it
    # matches, so let's get the nature it was matching.
    nature = PID % 25
    # And then we can play RNG backward from the seed until we see RNG that
    # would have generated a tentative PID with the same nature.
    while (True):
        seed = rng.reverseRng(seed, 1)
        upper = rng.top(seed)
        if ((upper % 25) == nature):
            # This is the first opportunity the game had to choose this nature.
            break
        # So since this wasn't the nature generating call, this was a tentative
        # PID call so we also have to burn the RNG that set the lower bits for
        # it.
        seed = rng.reverseRng(seed, 1)
    # Note that multiple encounters can generate the same PID at the same seed,
    # and this just returns the first possible one.  It also doesn't account
    # for Synchronize.
    # Return RNG reversed 2 times so that we're returning the seed used for the
    # Encoutner Slot.  The 1 we back up over is the level determination (always
    # happens even if the slot has no level range)
    return rng.reverseRng(seed, 2)
    

def FindPossibleIndeciesForPID(PID):
    indecies = []
    upper = PID >> 16
    lower = PID & 0xFFFF
    for i in range(1 << 16):
        seed = (lower << 16) + i
        seed = rng.advanceRng(seed, 1)
        if rng.top(seed) == upper:
            seed = FindFirstEncounterForPID(PID, seed)
            indecies.append(rng.index(seed))
    return indecies


def NearestShinyNut(index):
    # TODO: binary search?
    for possible in SHINY_INDEX:
        if possible > index:
            return possible
    return SHINY_INDEX[0]  # wrap around.


def time(advances):
    seconds = advances / AVERAGE_ADVANCES_PER_SECOND
    minutes = seconds // 60
    seconds = seconds % 60
    hours = minutes // 60
    minutes = minutes % 60
    return "%dh %dm %fs" % (hours, minutes, seconds)


SLOTS = {
    0: "POOCH 3",
    20: "WURMP 3",
    40: "POOCH 4",
    50: "WURMP 4",
    60: "LOTAD 3",
    70: "LOTAD 4",
    80: "ZIG 3",
    85: "ZIG 3",
    90: "ZIG 4",
    94: "RALTS 4",
    98: "ZIG 4",
    99:"NUT 3",
}

def Slot(rng):
    s = rng % 100
    slot = ""
    for key in SLOTS:
        if s >= key:
            slot = SLOTS[key]
    return slot


def ClosestNut(PID):
    for index in FindPossibleIndeciesForPID(PID):
        nut = NearestShinyNut(index)
        print("nut", nut, "index", index)
        slotRng = rng.advanceRng(0, index)
        print("slot", Slot(rng.top(slotRng)))
        print(time(nut - index))


def Forecast(index, duration=604800):
    """duration in seconds"""
    adv = duration * AVERAGE_ADVANCES_PER_SECOND
    seeds = filter((lambda x: x > index and x < (index+ adv)), SHINY_INDEX)
    i = 0
    for seed in seeds:
        print(time(seed-index))
        i += 1
    print("total:", i)


def main():
    PID = 0x6296E314
    ClosestNut(PID)
    # index = 648467497
    # Forecast(index)


if __name__ == '__main__':
    main()